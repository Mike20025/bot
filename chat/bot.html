<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏</title>

  <!-- ‚îÄ‚îÄ‚îÄ –°–¢–ò–õ–ò ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <style>
    html,body{margin:0;padding:0;background:transparent;font-family:Arial,Helvetica,sans-serif}

    /* –º–∏–Ω–∏-–∫–Ω–æ–ø–∫–∞-–ª–∞–Ω—á–µ—Ä 50√ó50 */
    #mini-launcher{
      position:fixed;z-index:10;
      width:60px;height:60px;border-radius:50%;border:none;background:#0086ff;
      display:block;cursor:pointer;bottom:0px;right:0px;will-change: box-shadow;  
    }
    #mini-launcher img{width:30px;height:30px}

    /* –æ–∫–Ω–æ —á–∞—Ç–∞ (–∏–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã—Ç–æ) */
    #chat-window{
      position:fixed;bottom:90px;right:20px;z-index:10;
      width:400px;height:500px;background: #007bff;border-radius:20px;
      display:none;flex-direction:column;overflow:hidden
    }

    /* –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
    #chat-header{display:flex;align-items:center;justify-content:space-between;padding: 22px 15px;background:#007bff;color:#fff}
    #chat-header .info{display:flex;align-items:center}
    #chat-header .info img{width:24px;height:24px;margin-right:10px}
    #chat-close{background:transparent;border:none;color:#fff;font-size:22px;cursor:pointer}

    /* —Å–æ–æ–±—â–µ–Ω–∏—è */
    #chat-messages{flex:1;overflow-y:auto;padding:20px 15px;display:flex;flex-direction:column;gap:10px;font-size:16px;background: #fff;border-radius: 22px 22px 0 0;}
    /* –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏-—Å—Ç—Ä–µ–ª–∫–∏ —É –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
    #chat-messages::-webkit-scrollbar {width: 8px;}
    #chat-messages::-webkit-scrollbar-button {background-color: transparent;}
    #chat-messages::-webkit-scrollbar-thumb {background-color: #f3f3f3;background-clip: padding-box;border-radius: 5px;border: 1px solid transparent;}
    #chat-messages::-webkit-scrollbar-track {background-color: transparent;}
    
    .message{max-width:86%;padding:8px 12px;border-radius:10px;word-wrap:break-word;display: flex;align-items: flex-start;}
    .message-bot{max-width: 100%;padding: 8px 0px;border-radius: 10px;word-wrap: break-word;display: flex;align-items: flex-start;}
    .avatar-bot {width:32px;height:32px;border-radius:10px;background:#194085;display:flex;align-items:center;justify-content:center;margin-right:10px;flex:0 0 32px;}
    .avatar-bot-logo {width:20px;height:20px}
    .bot{margin-right:auto}
    .box-text {display:flex;gap: 10px;flex-wrap: wrap;}
    .bot-text{color: #000000d9;line-height: 1.4;background:#f7f5f7;padding:8px 12px;border-radius: 10px}
    .bot-text a{color:#4e79eb;}
    .p-bot {font-size:10px;color: #00000060;font-weight: 600;}
    .user{background:linear-gradient(90deg,#2e559a 17%,#194085 100%);color:#fff;padding: 8px 12px;margin-left:auto;line-height: 1.4;max-width:70%;padding:8px 12px;border-radius: 10px 10px 3px 10px;word-wrap:break-word;display: flex;align-items: flex-start;}

    /* –±—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ */
.quick-btn{
  display:inline-block;margin:8px 6px 0 0;padding:8px 12px;
  font-size:16px;color:#4e79eb;background:#fff;
  border-radius:10px;cursor:pointer;white-space:nowrap;
  transition:background .15s,color .15s;
}
.quick-btn:hover{background:#5183fb;color:#fff}

/* –±–ª–æ–∫ –ø–æ–ª–∏—Ç–∏–∫–∏ */
.policy-box{
  margin-top:18px;padding:12px;border:1px solid #007bff;border-radius:10px;
  font-size:12px;line-height:1.35
}
.policy-box a{color:#4e79eb;text-decoration:underline}

    /* –≤–≤–æ–¥ */
    #chat-input{display:flex;align-items:center;padding:10px 15px;background: #fff;border-top:1px solid #ddd}
    #chat-question{flex:1;border:none;font-size:16px}
    #chat-question:focus{outline:none}
    #chat-send{width:40px;height:40px;border-radius:50%;border:none;margin-left:6px;background:#ccc;cursor:not-allowed;display:flex;align-items:center;justify-content:center;transition:background .2s}
    #chat-send.active{background:#63e5db;cursor:pointer}
    #chat-send img{width:18px;height:18px}
    
    /* –Ω–æ–º–µ—Ä–Ω–æ–π —Å–ø–∏—Å–æ–∫ */
    ol.custom-list {list-style: none;margin: 15px 0 0;padding: 0;counter-reset: item;}
    ol.custom-list li {position: relative;counter-increment: item;margin-bottom: 15px;padding-left: 35px;}
    ol.custom-list li::before {content: counter(item) "";position: absolute;left: 0;top: 0;width: 25px;height:25px;text-align: right;font-weight: bold;display: flex;align-items: center;justify-content: center;border-radius: 50%;font-size: 12px;background: #5183fb;color: #fff;}
    ol.custom-list li a {color: #4e79eb;text-decoration: underline;}
    
    .fancy-list {list-style: none;margin: 15px 0 0;padding: 0;}
    .fancy-list li {position: relative;padding-left: 35px;margin-bottom: 15px;}
    ul.fancy-list li::before {content: '';position: absolute;display: block;left: 10px;top: 8px;width: 6px;height: 6px;background-color: #000000d9;border-radius: 50%;}    
    
    /* ‚ñ∫ –Ω–µ–±–æ–ª—å—à–æ–µ ¬´–ø—Ä–∏—Ç—è–∂–µ–Ω–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è¬ª  */
@keyframes pulse {
  0%   { transform: scale(1);   box-shadow: 0 0   0   rgba(0,134,255,.4); }
  50%  { transform: scale(1.15);box-shadow: 0 0 15px rgba(0,134,255,.6); }
  100% { transform: scale(1);   box-shadow: 0 0   0   rgba(0,134,255,.4); }
}

.pulse {
  animation: pulse 1.2s ease-in-out infinite;
}

    /* –º–æ–±–∏–ª—å–Ω—ã–π ‚Äî –≤–æ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
    @media(max-width:480px){
      #chat-window{bottom:0;right:0;width:100vw!important;height:100dvh!important;top:0;left:0;border-radius:0 !important;}
      #chat-header{border-radius:0}
    }
  </style>
</head>
<body>
    


<!-- ‚îÄ‚îÄ‚îÄ –ú–ò–ù–ò-–ö–ù–û–ü–ö–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<button id="mini-launcher">
  <img src="https://abrnd.ru/chat/img/vidzhet.svg" alt="">
</button>

<!-- ‚îÄ‚îÄ‚îÄ –û–ö–ù–û –ß–ê–¢–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="chat-window">
  <div id="chat-header">
    <div class="info">
      <div>
        <div class="info-z">–ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏</div>
      </div>
    </div>
    <button id="chat-close" title="–ó–∞–∫—Ä—ã—Ç—å">√ó</button>
  </div>

  <div id="chat-messages"></div>

  <div id="chat-input">
    <input id="chat-question" type="text" placeholder="–í–∞—à –≤–æ–ø—Ä–æ—Å‚Ä¶">
    <button id="chat-send" disabled>
      <img src="https://static.tildacdn.com/tild6664-6338-4361-b633-373565653830/Send-active.svg" alt="">
    </button>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ –õ–û–ì–ò–ö–ê ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<script>
    /* ‚îÄ‚îÄ‚îÄ 1. DOM-—Å—Å—ã–ª–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    const launcher = document.getElementById('mini-launcher'),
          chatWin  = document.getElementById('chat-window'),
          closeBtn = document.getElementById('chat-close'),
          input    = document.getElementById('chat-question'),
          sendBtn  = document.getElementById('chat-send'),
          msgs     = document.getElementById('chat-messages');

    /* ‚îÄ‚îÄ‚îÄ 2. –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function normalizeText(s) {
      return s.toLowerCase().replace(/—ë/g, '–µ');
    }

    const greetingWords = (
      '–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ;–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é;–∑–¥—Ä–∞—Å—Ç–∏;–ø—Ä–∏–≤–µ—Ç;—Ö–∞–π;–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π;' +
      '—Å–∞–ª—é—Ç;–¥–æ–±—Ä—ã–π –¥–µ–Ω—å;–¥–æ–±—Ä—ã–π –≤–µ—á–µ—Ä;—Ö–∞—é —Ö–∞–π;–ø—Ä–∏–≤–µ—Ç–æ—Å;—á–æ –∫–∞–∫;–ø—Ä–∏–≤–µ—Ç–∏–∫'
    ).split(';');

    function isGreetingRecord(item){
      return item.keyword.split(';').every(w => greetingWords.includes(w.trim()));
    }
    function isSolelyGreeting(msg){
      const words = msg.replace(/[.,!?;:()\-]/g,' ')
                       .toLowerCase().trim()
                       .split(/\s+/);
      return words.length && words.every(w => greetingWords.includes(w));
    }

    function escRe(s){
      return s.replace(/[.+?^${}()|[\]\\]/g, '\\$&');
    }

    function makeRegexArr(str){
      return str.split(';').map(w => {
        const raw = w.trim();
        if (!raw) return null;
        const escaped = raw.replace(/[.+?^${}()|[\]\\]/g, '\\$&');
        const pattern = escaped.replace(/\*/g, '\\S*');
        return new RegExp('(^|\\s)' + pattern + '(?=[\\s.,!?;:]|$)', 'i');
      }).filter(Boolean);
    }

    function makeMinusArr(str){
      return str.split(';').map(w => {
        const raw = w.trim();
        if (!raw) return null;
        const escaped = raw.replace(/[.+?^${}()|[\]\\]/g, '\\$&');
        const pattern = escaped.replace(/\*/g, '\\S*');
        return new RegExp('(^|\\s)' + pattern + '(?=$|\\W)', 'i');
      }).filter(Boolean);
    }

    /* ‚îÄ‚îÄ‚îÄ 3. –ü–∞—Ä—Å–∏–Ω–≥ TSV —Å category ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    let KB = [];
    let kbReady = false;
    let lastCategory = null;

    function parseTSV(txt){
      const rows = txt.split('\n'), out = [];
      rows.forEach((l,i) => {
        if (!l.trim()) return;
        if (i === 0 && l.toLowerCase().includes('keyword')) return;
        const c = l.split('\t');
        if (c.length < 3) return; // keyword, minus, category, answer

        const raw = c[0].toLowerCase();
        const item = {
          category: c[2].trim(),
          answer: c[c.length - 1].trim()
        };

        if (raw.includes('|')) {
          const [cm, sv] = raw.split('|');
          item.rawCommonKeys  = cm.split(';').map(w => w.trim()).filter(Boolean);
          item.rawServiceKeys = sv.split(';').map(w => w.trim()).filter(Boolean);
          item.keyword        = normalizeText(raw);
        } else {
          item.rawKeys  = raw.split(';').map(w => w.trim()).filter(Boolean);
          item.keyword  = normalizeText(raw);
        }

        item.minus = normalizeText(c[1] || '');
        out.push(item);
      });

      out.forEach(it => {
        if (it.keyword.includes('|')) {
          const [cm, sv] = it.keyword.split('|');
          it.commonRegexes  = makeRegexArr(cm);
          it.serviceRegexes = makeRegexArr(sv);
        } else {
          it.regexes = makeRegexArr(it.keyword);
        }
        if (it.minus) {
          it.minusRegexes = makeMinusArr(it.minus);
        }
      });

      return out;
    }

/* ‚îÄ‚îÄ‚îÄ 4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Google —Å category ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function sendDataToGoogle(q, a) {
  // –û—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ category –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è
  console.log('payload –¥–ª—è –ª–æ–≥–æ–≤:', JSON.stringify({
    question: q,
    answer:   a,
    category: lastCategory
  }));

  // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π fetch ‚Äî –∑–¥–µ—Å—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å, –æ—Ç–≤–µ—Ç –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é
  fetch(
    'https://script.google.com/macros/s/AKfycbx5dGfN2VPKG5WSx0hqxbSPw9wNrT3R4kY4YVwQHxm0JBUsae5bO--houisvsY6k3I9Gg/exec',
    {
      method: 'POST',
      mode:   'no-cors',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        question: q,
        answer:   a,
        category: lastCategory
      })
    }
  ).catch(err => console.warn('Sheets logging error:', err));
}

    /* ‚îÄ‚îÄ‚îÄ 5. –í—ã–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function addMsg(html, who){
      const wrap = document.createElement('div');
      if (who === 'bot') {
        wrap.className = 'message-bot bot';
        wrap.innerHTML =
          '<div class="avatar-bot">' +
            '<img src="https://abrnd.ru/chat/img/logo-mini.svg" class="avatar-bot-logo">' +
          '</div>' +
          '<div class="box-text">' +
            '<div class="bot-text">' + html + '</div>' +
            '<div class="p-bot">–ë–æ—Ç&nbsp;–°–∞–Ω—Ç–∞–ª—å</div>' +
          '</div>';
      } else {
        wrap.className = 'user';
        wrap.textContent = html;
      }
      msgs.appendChild(wrap);
      if (who === 'bot') {
        wrap.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } else {
        msgs.scrollTop = msgs.scrollHeight;
      }
    }

    /* ‚îÄ‚îÄ‚îÄ 6. –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –±—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function showWelcome(){
      const html =
        '–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –±–æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫–∏ ¬´–°–∞–Ω—Ç–∞–ª—å¬ª. –ù–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –±—ã—Å—Ç—Ä—ã–π –≤–∞—Ä–∏–∞–Ω—Ç üòä' +
        '<br><br>' +
        '<span class="quick-btn">–ö–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è</span>' +
        '<span class="quick-btn">–£–∑–Ω–∞—Ç—å —Ü–µ–Ω—ã</span>' +
        '<span class="quick-btn">–°–ø—Ä–∞–≤–∫–∞ 003-–í/–£</span>' +
        '<span class="quick-btn">–ö–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è</span>' +
        '<div class="policy-box" style="margin-top:18px">' +
          '–ü—Ä–æ–¥–æ–ª–∂–∞—è –æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç–µ, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å ' +
          '<a href="https://santal-novosibirsk.ru/privacy/" target="_blank">–ø–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a> –∏ ' +
          '<a href="https://santal-novosibirsk.ru/agreement/" target="_blank">–æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</a>.' +
        '</div>';
      addMsg(html,'bot');
    }

    /* ‚îÄ‚îÄ‚îÄ 7. –ü–æ–∏—Å–∫ –æ—Ç–≤–µ—Ç–∞ —Å —É—á—ë—Ç–æ–º category ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function findAnswer(q) {
  const norm    = normalizeText(q);
  const matched = [];

  /* –£—Ç–∏–ª–∏—Ç–∞: —Å–ª—É—á–∞–π–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç, –µ—Å–ª–∏ –≤ answer –µ—Å—Ç—å ¬´|¬ª */
  function chooseAnswer(ans) {
    if (ans.includes('|')) {
      const parts = ans.split('|').map(s => s.trim());
      return parts[Math.floor(Math.random() * parts.length)];
    }
    return ans;
  }

  /* 1) –ø—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–∞–ø—Ä–æ—Å —á–∏—Å—Ç—ã–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º */
  const isJustGreeting = isSolelyGreeting(norm);
  if (isJustGreeting) {
    const greetItem = KB.find(it => isGreetingRecord(it));
    if (greetItem) {
      lastCategory = greetItem.category;
      return chooseAnswer(greetItem.answer);
    }
  }

  /* 2) –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ö–æ–¥ –ø–æ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π */
  KB.forEach(it => {
    /* –æ—Ç—Å–µ–∫–∞–µ–º –º–∏–Ω—É—Å-—Å–ª–æ–≤–∞ */
    if (it.minusRegexes && it.minusRegexes.some(r => r.test(norm))) return;

    let score = 0, hitLabel = null;

    /*   ‚îÄ‚îÄ common|service ‚îÄ‚îÄ   */
    if (it.commonRegexes && it.serviceRegexes) {
      const c = it.commonRegexes .reduce((s,r)=>s+(r.test(norm)?1:0),0);
      const s = it.serviceRegexes.reduce((s,r)=>s+(r.test(norm)?1:0),0);
      if (c>0 && s>0) {
        score    = c + s*2;
        hitLabel = it.rawServiceKeys[0];
      }
    }
    /*   ‚îÄ‚îÄ –æ–±—ã—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–π ‚îÄ‚îÄ   */
    else if (it.regexes) {
      for (let i = 0; i < it.regexes.length; i++) {
        if (it.regexes[i].test(norm)) {
          score    = 1;
          hitLabel = it.rawKeys[i];
          break;
        }
      }
    }

    if (score) {
      let display = hitLabel.replace(/(–æ–≥–æ|–æ–º—É|–∞|—É)$/i,'');
      if (/^–∑–∞–ø–∏—Å/i.test(display)) display = '–∑–∞–ø–∏—Å—å';
      matched.push({
        score,
        answer   : it.answer,
        display  : display,
        category : it.category
      });
    }
  });

  /* 3) —É–±–∏—Ä–∞–µ–º –æ—Ç–≤–µ—Ç—ã-¬´–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ¬ª, –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –±—ã–ª –ù–ï —Ç–æ–ª—å–∫–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º */
  if (!isJustGreeting) {
    for (let i = matched.length - 1; i >= 0; i--) {
      const cat = (matched[i].category || '').toLowerCase();
      if (cat.includes('–ø—Ä–∏–≤–µ—Ç')) matched.splice(i, 1);
    }
  }

  /* 4) fallback, –∫–æ–≥–¥–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–¥–æ—à–ª–æ */
  if (!matched.length) {
    lastCategory = '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    const fallbackAnswers = [
      // –í–∞—Ä–∏–∞–Ω—Ç 1
      '–ü—Ä–æ—Å—Ç–∏—Ç–µ, —è –ø–æ–∫–∞ –Ω–µ –∑–Ω–∞—é, –∫–∞–∫ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å. –Ø –µ—â—ë —É—á—É—Å—å üòä<br><br>' +
      '–ú–æ–∂–µ—Ç–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∑–∞ –ø–æ–º–æ—â—å—é –∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É.<br><br>' +
      '<span class="quick-btn" data-intent="operator_clinic">–ü–æ–∑–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</span>',
      // –í–∞—Ä–∏–∞–Ω—Ç 2
      '–Ø –≤—Å—ë –µ—â—ë —É—á—É—Å—å –ø–æ–Ω–∏–º–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã ü§ñ<br><br>' +
      '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∑–∞ –ø–æ–º–æ—â—å—é –∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É.<br><br>' +
      '<span class="quick-btn" data-intent="operator_clinic">–ü–æ–∑–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</span>',
      // –í–∞—Ä–∏–∞–Ω—Ç 3
      '–ü–æ–∫–∞ –Ω–µ –º–æ–≥—É —Ç–æ—á–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å üòî –ù–æ —è —É—á—É—Å—å –Ω–∞ –∫–∞–∂–¥–æ–º –≤–æ–ø—Ä–æ—Å–µ, —á—Ç–æ–±—ã —Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è –ª—É—á—à–µ.<br><br>' +
      '–ú–æ–∂–µ—Ç–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏–Ω–∞—á–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∑–∞ –ø–æ–º–æ—â—å—é –∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É.<br><br>' +
      '<span class="quick-btn" data-intent="operator_clinic">–ü–æ–∑–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</span>'
    ];
    return fallbackAnswers[Math.floor(Math.random() * fallbackAnswers.length)];
  }

  /* 5) –≤—ã–±–∏—Ä–∞–µ–º –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç –∏–∑ matched */
  matched.sort((a,b)=> b.score - a.score || a.answer.length - b.answer.length);
  const topScore = matched[0].score;
  const topItems = matched.filter(m => m.score === topScore);

  if (topItems.length === 1) {
    lastCategory = topItems[0].category;
    return chooseAnswer(topItems[0].answer);
  }

  /* 6) –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–≤–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ ‚Äî —Å–æ–±–∏—Ä–∞–µ–º –±–ª–æ–∫–∏ */
  const sorted = [
    ...topItems.filter(i => i.display === '–∑–∞–ø–∏—Å—å'),
    ...topItems.filter(i => i.display !== '–∑–∞–ø–∏—Å—å')
  ];
  lastCategory = sorted[0].category;

  const blocks = sorted.map(it =>
    `<strong>–ü–æ —Ç–µ–º–µ ¬´${it.display}¬ª:</strong><br>${chooseAnswer(it.answer)}`
  );
  return [...new Set(blocks)].join('<br><br>');
}

    /* ‚îÄ‚îÄ‚îÄ 8. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    function processUserQuestion(q){
      if (!kbReady) {
        setTimeout(() => processUserQuestion(q), 100);
        return;
      }
      addMsg(q, 'user');
      const a = findAnswer(q);
      setTimeout(() => addMsg(a, 'bot'), 500);
      sendDataToGoogle(q, a);
    }

    /* ‚îÄ‚îÄ‚îÄ 9. UI-—Å–æ–±—ã—Ç–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∞ TSV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    launcher.onclick = ()=>{
      launcher.style.display='none';
      chatWin.style.display='flex';
      parent.postMessage({type:'chat',action:'expand'},'*');
      if(!msgs.childElementCount) showWelcome();
    };

    closeBtn.onclick = ()=>{
      chatWin.style.display='none';
      launcher.style.display='block';
      parent.postMessage({type:'chat',action:'collapse'},'*');
    };

    input.oninput = ()=>{
      const ok = input.value.trim().length > 0;
      sendBtn.disabled = !ok;
      sendBtn.classList.toggle('active', ok);
    };

    function send(){
      const q = input.value.trim();
      if(!q) return;
      input.value = '';
      sendBtn.disabled = true;
      sendBtn.classList.remove('active');
      processUserQuestion(q);
    }
    sendBtn.onclick = send;
    input.onkeypress = e => { if(e.key==='Enter') send(); };

    msgs.addEventListener('click', e => {
      if (!e.target.classList.contains('quick-btn')) return;
      const intent = e.target.dataset.intent  ?? e.target.textContent.trim();
      const label  = e.target.textContent.trim();
      addMsg(label, 'user');
      const answer = findAnswer(intent);
      setTimeout(() => addMsg(answer, 'bot'), 500);
      sendDataToGoogle(intent, answer);
    });

    const baseUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTx1uVZ0r0qA_8cke68kTnHooWaiqgv4YoG5pVnDiMON9coL2IF5SSqP5z59FDH8dzne4OdKQOGVz7Q/pub?output=tsv';
    const tsvUrl = baseUrl + '&t=' + Date.now();
    fetch(tsvUrl, { cache: 'no-store' })
      .then(r => r.text())
      .then(txt => {
        KB = parseTSV(txt);
        console.log('KB rows:', KB.length);
        kbReady = true;
      })
      .catch(() =>
        addMsg('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.', 'bot')
      );

    parent.postMessage({type:'chat',action:'collapse'},'*');

    /* ‚îÄ‚îÄ‚îÄ 10. –ê–Ω–∏–º–∞—Ü–∏—è ¬´–ø—É–ª—å—Å¬ª ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    (function () {
      var FLASH_MS   = 3000;
      var PERIOD_MS  = 8000;
      document.addEventListener('DOMContentLoaded', function () {
        function flash () {
          if (launcher.style.display === 'none') { return; }
          launcher.classList.add('pulse');
          setTimeout(function () {
            launcher.classList.remove('pulse');
          }, FLASH_MS);
        }
        flash();
        setInterval(flash, PERIOD_MS);
      });
    }());
  </script>






<script>
  /* ‚îÄ‚îÄ –ê–Ω–∏–º–∞—Ü–∏—è ¬´–ø—É–ª—å—Å¬ª —Ä–∞–∑ –≤ 8 —Å–µ–∫—É–Ω–¥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  (function () {
    /* —Å–∫–æ–ª—å–∫–æ –¥–ª–∏—Ç—Å—è –æ–¥–Ω–∞ ¬´–≤—Å–ø—ã—à–∫–∞¬ª (–º—Å) –∏ –∫–∞–∫ —á–∞—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä—è—Ç—å */
    var FLASH_MS   = 3000;   // 3 —Å
    var PERIOD_MS  = 8000;   // 8 —Å

    /* –∑–∞–ø—É—Å–∫–∞–µ–º —Ü–∏–∫–ª –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ bot.html */
    document.addEventListener('DOMContentLoaded', function () {

      /* –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ‚Äì –ø—Ä–æ—â–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏ —Ä–∞—Å–∫—Ä—ã—Ç–æ–º —á–∞—Ç–µ */
      function flash () {
        /* –Ω–µ –¥—ë—Ä–≥–∞–µ–º –∫–Ω–æ–ø–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ —Å–∫—Ä—ã—Ç–∞ (—á–∞—Ç –æ—Ç–∫—Ä—ã—Ç) */
        if (launcher.style.display === 'none') { return; }

        launcher.classList.add('pulse');          /* —Å—Ç–∞—Ä—Ç */
        setTimeout(function () {                  /* —á–µ—Ä–µ–∑ 3 —Å ‚Äì —Å—Ç–æ–ø */
          launcher.classList.remove('pulse');
        }, FLASH_MS);
      }

      /* –ø–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ –∏ –¥–∞–ª—å–Ω–µ–π—à–∏–µ –ø–æ–≤—Ç–æ—Ä—ã */
      flash();
      setInterval(flash, PERIOD_MS);
    });
  }());
</script>
</body>
</html>
